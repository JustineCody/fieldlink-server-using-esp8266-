{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container">
  <!-- ğŸŒ¿ Animated Header Icons -->
  <div class="header-anim">
    <span style="font-size: 2.5rem;">ğŸŒ¿</span>
    <span style="font-size: 2.5rem;">ğŸŒŠ</span>
    <span style="font-size: 2.5rem;">ğŸ§ª</span>
  </div>

  <!-- ğŸ‘‹ Glowing Personalized Greeting -->
  <div class="greeting">
    <h2 class="glow-greet">Nice to meet you, {{ username }}! ğŸ‘‹</h2>
    <p class="glow-sub">Letâ€™s explore your seaweed dashboard and check todayâ€™s ocean health readings ğŸŒŠ</p>
  </div>

  <!-- ğŸŒŠ Seaweed-Themed Welcome Box -->
  <div class="welcome-box seaweed-theme">
    <h1 class="glow-text">Welcome to <span class="brand-name">SAVING SEAWEEDS</span> ğŸŒ±</h1>
    <p>Monitoring ocean health, empowering sustainable farms, and protecting marine ecosystems â€” one sensor at a time.</p>
    <label class="theme-toggle">
      <input type="checkbox" id="themeSwitch">
      <span class="slider"></span> Toggle Ocean Mode
    </label>
  </div>

  <!-- ğŸ“Š Sensor Readings -->
  <div class="sensor-card">
    <h3>Sensor Readings</h3>
    <p title="Ideal: 24â€“32Â°C">
      ğŸŒ¡ï¸ Temperature: <span id="temp" class="">--</span> Â°C <span id="temp-icon" class="icon"></span>
    </p>
    <p title="Ideal: 40â€“70%">
      ğŸ’§ Humidity: <span id="hum" class="">--</span> % <span id="hum-icon" class="icon"></span>
    </p>
    <p title="Ideal: 6.5â€“8.5">
      ğŸ§ª pH Level: <span id="ph" class="">--</span> <span id="ph-icon" class="icon"></span>
    </p>
    <p title="Ideal: 5â€“35 ppt">
      ğŸŒŠ Salinity: <span id="sal" class="">--</span> ppt <span id="sal-icon" class="icon"></span>
    </p>
  </div>

  <!-- ğŸ§­ Legend -->
  <div class="legend">
    <h4>Legend</h4>
    <p><span class="safe">âœ… Safe</span> â€” within optimal range</p>
    <p><span class="warn">âš ï¸ Warning</span> â€” slightly outside range</p>
    <p><span class="danger">âŒ Danger</span> â€” critical level</p>
  </div>

  <!-- ğŸ“ Export Button -->
  <button onclick="exportCSV()">ğŸ“ Export Readings</button>
</div>

<!-- ğŸ§  Sensor Logic -->
<script>
  let log = [];

  function classify(value, type) {
    if (type === 'temp') {
      if (value < 22 || value > 35) return ['danger', 'âŒ'];
      if (value < 24 || value > 32) return ['warn', 'âš ï¸'];
      return ['safe', 'âœ…'];
    }
    if (type === 'hum') {
      if (value < 30 || value > 80) return ['danger', 'âŒ'];
      if (value < 40 || value > 70) return ['warn', 'âš ï¸'];
      return ['safe', 'âœ…'];
    }
    if (type === 'ph') {
      if (value < 6.0 || value > 9.0) return ['danger', 'âŒ'];
      if (value < 6.5 || value > 8.5) return ['warn', 'âš ï¸'];
      return ['safe', 'âœ…'];
    }
    if (type === 'sal') {
      if (value < 0 || value > 40) return ['danger', 'âŒ'];
      if (value < 5 || value > 35) return ['warn', 'âš ï¸'];
      return ['safe', 'âœ…'];
    }
    return ['', ''];
  }

  function fetchSensorData() {
    fetch('/sensor-data')
      .then(response => response.json())
      .then(data => {
        const sensors = [
          { id: 'temp', value: data.temperature, type: 'temp' },
          { id: 'hum', value: data.humidity, type: 'hum' },
          { id: 'ph', value: data.ph, type: 'ph' },
          { id: 'sal', value: data.salinity, type: 'sal' }
        ];

        const timestamp = new Date().toLocaleString();
        const entry = { timestamp };

        sensors.forEach(sensor => {
          const span = document.getElementById(sensor.id);
          const icon = document.getElementById(sensor.id + '-icon');
          const [status, symbol] = classify(sensor.value, sensor.type);

          span.textContent = sensor.value;
          span.className = status + ' animated';
          icon.textContent = symbol;
          icon.className = 'icon animated';

          entry[sensor.id] = sensor.value;
          entry[sensor.id + '_status'] = status;
        });

        log.push(entry);
      });
  }

  function exportCSV() {
    let csv = 'Timestamp,Temperature,Temp Status,Humidity,Hum Status,pH,pH Status,Salinity,Sal Status\n';
    log.forEach(row => {
      csv += `${row.timestamp},${row.temp},${row.temp_status},${row.hum},${row.hum_status},${row.ph},${row.ph_status},${row.sal},${row.sal_status}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sensor_log.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  setInterval(fetchSensorData, 3000);

  // ğŸŒ— Theme Toggle
  document.getElementById('themeSwitch').addEventListener('change', function () {
    document.body.classList.toggle('dark-mode');
  });
</script>
{% endblock %}
